{% extends "layout.html" %}

{% block title %}
    Work
{% endblock %}

{% block main %}

    <audio class="win">
    <source src="/static/win.wav" type="audio/wav">
    </audio>
    <audio class="loose">
    <source src="/static/loose.wav" type="audio/wav">
    </audio>

    <div class="stats_container">
      <span class="vertical">
      Show Stats
      </span>
    <span class="text-left">
      <p>
            Average solving time
            <br>
            {{avg_time}} Seconds
          </p>
          <p>
            Average sucess rate
            <br>
            {{sucess_rate}}%
          </p></span>

    </div>

    {% for category, message in get_flashed_messages(with_categories=true) %}
    <div class="alert {{category}}">{{ message }}</div>
    {% endfor %}


    <h2 class="p-3">Earn Captcha Coin here</h2>
    <h3>Current cash {{cash}} Coins</h3>
    <h4>{{cash | dollar}}</h4>
    <p>time of last solved captcha {{time}} seconds
      <img class="sound" alt="" width="20px">
    </p>
    <img id="captcha" src="data:image/jpeg;base64,{{ captcha }}" alt="captcha" class="mb-2">
    <form method="post" action="/validate">
      <input type="text" name="key" id="work_input" data-added="0" autocomplete="off" autofocus>
      <button type="submit" name="time" id="work_submit" class="btn btn-secondary btn-sm" onsubmit="this.disabled = true">
        Send
      </button>
    </form>

    <script type="text/javascript">
      const work_input = document.querySelector("#work_input");
      const work_submit = document.querySelector("#work_submit")
      const captcha = document.querySelector("#captcha");
      const alert = document.querySelector(".alert");
      const stats_container = document.querySelector(".stats_container");
      stats_width = stats_container.querySelector(".text-left").getBoundingClientRect().width;
      stats_height = stats_container.querySelector(".text-left").getBoundingClientRect().height;
      const sound = document.querySelector(".sound");

      function position() {
        captcha_coords = captcha.getBoundingClientRect()
        if(isMobile){
          stats_container.style.setProperty('top', `-${stats_height - 60}px`);
          stats_container.style.setProperty('left', "50%");
        }
        else {
          stats_container.style.setProperty('left', `-${stats_width + 5}px`);
          stats_container.style.setProperty('top', "20%");
          if (alert != null)
          {
            alert_coords = alert.getBoundingClientRect();
            const coords = {
              top: captcha_coords.top - (alert_coords.width/2),
              left: captcha_coords.left - (alert_coords.width/2)
            }

            alert.style.setProperty('top', `${coords.top}px`);
            alert.style.setProperty('left', `${coords.left}px`);
            if(localStorage["sound"] != null){
               if (alert.classList.contains("point")){
                 document.querySelector(".win").play();
               }
               else{
                 document.querySelector(".loose").play();
               }
            }
          }
        }
      }

      function open_stats() {
        if (stats_container.classList.contains("active")) {
           stats_container.classList.remove("active"); }
        else {
           stats_container.classList.add("active");
       }
     }

     let time
     let start
     function timer(e){
       if (e.type == 'keydown'){
         if (work_input.dataset.added == "0")
         {
           start = e.timeStamp;
           work_input.dataset.added = "1"
         }
       }
       else
       {
         end = e.timeStamp;
         time = Math.round(end - start)/1000;
         work_submit.value = time;
       }
     }

     function timer_stop(){
       work_input.dataset.added = "0"
     }

     function sound_toggle(){
       if (localStorage["sound"] == null){
         localStorage["sound"] = "on";
         sound.src = "/static/on.svg"
       }
       else {
         localStorage.removeItem('sound')
          sound.src = "/static/off.svg"
       }
     }

     function sound_check(){
       if (localStorage["sound"] != null){
         sound.src = "/static/on.svg"
       }
       else {
         localStorage.removeItem('sound')
          sound.src = "/static/off.svg"
       }
     }

      sound_check();
      position();
      sound.addEventListener('click', sound_toggle);
      stats_container.addEventListener('click', open_stats);
      window.addEventListener('resize', position);
      window.addEventListener('DOMContentLoaded', position);
      work_input.addEventListener('keydown', timer);
      work_input.addEventListener('focusout', timer_stop);
      work_submit.addEventListener('click', timer);

    </script>
{% endblock %}
